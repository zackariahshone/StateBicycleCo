define(["require","exports","tslib","jquery","react","classnames","modules/clean/react/prompt/prompt_location","modules/clean/react/prompt/button","modules/clean/react/prompt/dig2_buttons","modules/clean/animation","modules/clean/upsell/upsell_controller","modules/clean/react/css","modules/clean/react/sprite","modules/clean/react/prompt/image","modules/clean/static_urls","modules/core/i18n"],(function(e,t,a,n,o,r,s,i,l,u,c,p,d,m,b,g){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n=a.__importDefault(n),o=a.__importDefault(o),r=a.__importDefault(r),c=a.__importDefault(c);var f=20,h=-20,B=39,v=-39,C=(function(e){function t(t,s){var l=e.call(this,t,s)||this;return l.getTargetedElement=function(){return n.default(l.props.campaign.content.targetSelector).first()},l.isTargetedElementVisible=function(){var e=l.getTargetedElement();return e.length>0&&e.is(":visible")},l.isTargetInDocument=function(e){return document.body.contains(e[0])},l.getPromptSilo=function(){return n.default("#prompt-silo")},l.waitForElementThenSetupAndPosition=function(e){void 0===e&&(e=Date.now()),l.isTargetedElementVisible()?l.setupControlsAndPositionBubble():setTimeout((function(){return l.waitForElementThenSetupAndPosition(e)}),200)},l.baseOnClick=function(e){null!=l.repositioner&&l.repositioner.stop(),l.setState({isShown:!1}),void 0!==l.$backdropElements&&l.$backdropElements.backdrop.remove(),l.$allJQueryButtons&&l.$allJQueryButtons.off("click",l.jqueryOnClickHandler)},l.jqueryOnClickHandler=function(e){l.baseOnClick(e),"#"===n.default(e.currentTarget).attr("href")&&e.preventDefault()},l.onConfirm=function(e){l.state_manager.onConfirm(e),l.baseOnClick(e)},l.onDismiss=function(e){l.state_manager.onDismiss(e),l.baseOnClick(e)},l.buildUpsellControllerOptions=function(){return a.__assign(a.__assign(a.__assign({},l.props),l.props.campaign),l.props.campaign.content)},l.setupControlsAndPositionBubble=function(){var e,t=l.getTargetedElement(),a=t;l.props.campaign.content.hasBackdrop&&(l.$backdropElements=l.setupAndPositionBackdrop(t),a=a.add(l.$backdropElements.backdropHole),e=l.$backdropElements.backdrop),e=e||n.default(),new c.default(a,e,l.buildUpsellControllerOptions()),l.$allJQueryButtons=a.add(e),l.$allJQueryButtons.on("click",l.jqueryOnClickHandler),l.state_manager.onShow(),l.setState({},(function(){var e=t;l.props.campaign.content.hasBackdrop&&l.$backdropElements&&(e=l.$backdropElements.backdropHole);var a=function(){return l.setState({targetedBubbleWrapperZIndex:l._elementZIndex(e)+1}),l.positionBubbleAbsolute(e)};if(a(),!l.props.campaign.content.hasBackdrop)return l.repositioner=new u.RenderAtFps(a,60),l.repositioner.start()}))},l.isTargetFixed=function(e){return e.parents().filter((function(){return"fixed"===n.default(this).css("position")})).length>0},l.getTargetedBubbleImage=function(){var e=l.props.campaign.content,t=e.confirmText,a=e.imageUrl;if(a)return o.default.createElement("div",{className:"targeted-bubble__image"},o.default.createElement("img",{className:"image",src:a,alt:t||void 0}))},l.getBubbleWrapperClassName=function(){var e={"targeted-bubble-wrapper":!0};return l.props.isPreview?(e.active=!0,e.static=!0,r.default(e)):(e.active=l.state.isShown,r.default(e))},l._elementZIndex=function(e){for(;e.length&&e[0]!==document;){var t=e.css("position");if(["absolute","relative","fixed"].includes(t)){var a=parseInt(e.css("zIndex"),10);if(!isNaN(a)&&0!==a)return a}e=e.parent()}return 0},l._elementDocumentRelativeRect=function(e){var t=e.getBoundingClientRect(),a=window.pageXOffset,n=window.pageYOffset;return{top:t.top+n,left:t.left+a,width:t.width,height:t.height}},l.positionBubbleAbsolute=function(e){if(l.props.campaign.content.hasBackdrop||(e=l.getTargetedElement()),!l.isTargetInDocument(e)||!l.targetedBubbleWrapperRef.current)return l.setState({isShown:!1}),void(null!=l.repositioner&&l.repositioner.stop());var t=l.props.campaign.content.placement,a=l._elementDocumentRelativeRect(e[0]),o=l.targetedBubbleWrapperRef.current.getBoundingClientRect().height,r=l.getPositionTop(t,a,o),s=n.default(window).height();if(r+o-window.pageYOffset>s){var i=r-o-2*v;i>0&&"bottom"!==t&&"top"!==t?(r=i,l.setState({addBottomRelativeClassToTargetedBubble:!0})):l.setState({addBottomRelativeClassToTargetedBubble:!1})}else l.setState({addBottomRelativeClassToTargetedBubble:!1});var u=l.targetedBubbleWrapperRef.current.getBoundingClientRect().width,c=l.getPositionLeft(t,a,u);l.setState({bubbleWrapperTopLeft:{top:r,left:c}})},l.setupAndPositionBackdrop=function(e){n.default(".targeted-bubble-backdrop__hole, .targeted-bubble-backdrop").remove();var t=n.default("<div></div>").addClass("targeted-bubble-backdrop__hole"),a=n.default("<div></div>").addClass("targeted-bubble-backdrop").append(t);l.getPromptSilo().append(a);var o=e.offset();return t.css({boxShadow:"rgba(0, 0, 0, 0.6) 0 0 0 30000px, inset 0 0 0 #111",width:e.outerWidth(),height:e.outerHeight(),position:l.isTargetFixed(e)?"fixed":"absolute",cursor:e.css("cursor")}),t.offset(o),{backdrop:a,backdropHole:t}},l.getButtonClassName=function(){return l.props.campaign.content.imageUrl?void 0:"small-margin"},l.getBubbleWrapperStyle=function(){return{zIndex:l.state.targetedBubbleWrapperZIndex,top:l.state.bubbleWrapperTopLeft?l.state.bubbleWrapperTopLeft.top:void 0,left:l.state.bubbleWrapperTopLeft?l.state.bubbleWrapperTopLeft.left:void 0}},l.getBubbleClassName=function(){var e=l.props.campaign.content,t=e.placement,a=e.colorStyle;return r.default({"chat-bubble":!0,"targeted-bubble":!0,"chat-bubble-top":null!==t&&("bottom"===t||"bottom-right"===t),"chat-bubble-right":null!==t&&"left"===t,"chat-bubble-left":null===t||"right"===t,"chat-bubble-bottom":null!==t&&"top"===t,"bottom-relative":l.state.addBottomRelativeClassToTargetedBubble,"with-x-icon":l.props.campaign.content.cancelWithXIcon,"without-x-icon":!l.props.campaign.content.cancelWithXIcon,dark:"dark"===a})},l.getExtraArrowClassNames=function(e){var t={black:"dark"===l.props.campaign.content.colorStyle,"left-arrow":"bottom-right"===l.props.campaign.content.placement};return t[e]=!0,r.default(t)},l.getPositionLeft=function(e,t,a){return"top"===e||"bottom"===e?t.left+Math.floor(t.width/2)-a+B:"bottom-right"===e?t.left+Math.floor(t.width/2)+h:"left"===e?h-a+t.left:-h+t.width+t.left},l.getPositionTop=function(e,t,a){return"bottom"===e||"bottom-right"===e?t.top+t.height+f:"top"===e?t.top-(a+f):v+t.top+Math.floor(t.height/2)},l.onDismissIconClick=function(e){l.props.isPreview||(l.setState({isShown:!1}),l.state_manager.onDismiss(e))},l.renderDismissButtonSprite=function(){return"dark"===l.props.campaign.content.colorStyle?o.default.createElement(m.Image,{src:b.static_url("/static/images/top-notification-x-white-vflCh9Pt1.svg"),alt:g.intl.formatMessage({id:"v4qAYu",defaultMessage:"Close"})}):o.default.createElement(d.Sprite,{group:"web",name:"close_small",alt:g.intl.formatMessage({id:"v4qAYu",defaultMessage:"Close"})})},l.renderDismissButton=function(){return l.props.campaign.content.cancelWithXIcon?o.default.createElement(i.DismissButton,{className:"close-button dismiss-x-icon",onDismiss:l.onDismissIconClick,"aria-label":g.intl.formatMessage({id:"v4qAYu",defaultMessage:"Close"})},l.renderDismissButtonSprite()):null},s=a.__assign(a.__assign({},s),{addBottomRelativeClassToTargetedBubble:!1,bubbleWrapperTopLeft:void 0}),l.targetedBubbleWrapperRef=o.default.createRef(),l}return a.__extends(t,e),t.prototype.componentDidMount=function(){this.props.isPreview||this.waitForElementThenSetupAndPosition()},t.prototype.render=function(){var e=this.props.campaign.content,t=e.header,a=e.text,n=t?o.default.createElement("h2",{className:"title"},t):null;return"dark"===this.props.campaign.content.colorStyle?o.default.createElement("div",{className:this.getBubbleWrapperClassName(),style:this.getBubbleWrapperStyle(),ref:this.targetedBubbleWrapperRef},o.default.createElement("div",{className:this.getBubbleClassName()},n,o.default.createElement("span",{className:"targeted-bubble__text"},a),this.getTargetedBubbleImage(),o.default.createElement(l.PromptButtonsDIG2,{campaign:this.props.campaign,confirmIsPost:this.state_manager.shouldConfirmUsingPost(),confirmUrl:this.state_manager.buildConfirmEndpointURI(),onConfirm:this.onConfirm,onDismiss:this.onDismiss,confirmButtonClassName:this.getButtonClassName(),dismissButtonClassName:this.getButtonClassName()}),this.renderDismissButton(),o.default.createElement("div",{className:this.getExtraArrowClassNames("chat-bubble-arrow-border")}),o.default.createElement("div",{className:this.getExtraArrowClassNames("chat-bubble-arrow")}))):o.default.createElement("div",{className:this.getBubbleWrapperClassName(),style:this.getBubbleWrapperStyle(),ref:this.targetedBubbleWrapperRef},o.default.createElement("div",{className:this.getBubbleClassName()},this.getTargetedBubbleImage(),n,o.default.createElement("span",{className:"targeted-bubble__text"},a),o.default.createElement(i.PromptButtons,{campaign:this.props.campaign,confirmIsPost:this.state_manager.shouldConfirmUsingPost(),confirmUrl:this.state_manager.buildConfirmEndpointURI(),onConfirm:this.onConfirm,onDismiss:this.onDismiss,confirmButtonClassName:this.getButtonClassName(),dismissButtonClassName:this.getButtonClassName()}),this.renderDismissButton(),o.default.createElement("div",{className:this.getExtraArrowClassNames("chat-bubble-arrow-border")}),o.default.createElement("div",{className:this.getExtraArrowClassNames("chat-bubble-arrow")})))},t.displayName="TargetedBubbleWithoutCSS",t})(s.PromptLocation);t.TargetedBubbleRendererWithoutCSS=C,t.TargetedBubble=p.requireCssWithComponent(C,["/static/css/upsell/targeted_bubble-vfllgGqQ3.css","/static/css/chatbubble-vflAxqf1H.css","/static/css/dig-components/index.web-vflyKkT3N.css"])}));
//# sourceMappingURL=targeted_bubble.min.js-vflWA59hg.map